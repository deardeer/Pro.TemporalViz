<head>
    <script src="./lib/jquery.js"></script>
    <script src='./lib/plotly-1.5.0.min.js'></script>
    <script src="./lib/d3.v5.min.js"></script>
    <script src="./lib/lurlquery.js"></script>
    <script src="./lib/drawfun.js"></script>
    <script src="./tail.js"></script>
    <script type="text/javascript" src="./lib/d3-ForceEdgeBundling.js"></script>
</head>

<body>
    <div>
        <svg id='mysvg' style="width: 600px; height: 600px; margin: 100px; border: solid 0.5px">
            <defs>
                <linearGradient id="orange_red" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:rgb(255, 251, 9);
                stop-opacity:1"/>
                <stop offset="100%" style="stop-color:rgb(241, 105, 19);
                stop-opacity:1"/>
                </linearGradient>
            </defs>
        </svg>
    </div>
</body>

<script>
    gData = []

    loadData()

    //rainbow style
    // var Rcolor = d3.interpolateRainbow;
    //single tone style
    Rcolor = d3.scaleLinear()
               .domain([0, 1])
               .range(['white', d3.schemeOrRd[9][5]]) //Rcolor(1)])
               .interpolate(d3.interpolateHcl)

    var path = d3.select("path").remove();
   
    function loadData(){
        console.log('load data');
        // var lSendUrl = function(PostType, Url, formData, successPaperState, self)
        var formData = new FormData();
        lSendUrl('POST', 'http://localhost:30001/getPlotData', formData, successGetData)
    }

    function successGetData(response){
        console.log('response=', response['data'], response['bound'], response['drawids'])
        drawPlot(response['data'], response['bound'], response['ids'], response['steps'], response['drawids'])
    }

    function drawPlot(data, bound, ids, steps, drawids){

        var liBox=[[[280.5, 319.5],[85.5, 203.5]],
                    [[80.5, 280.5],[85.5, 203.5]],
                    [[320, 398], [130, 210]],
                    [[0, 600], [0, 600]]]

        liSelectIds = drawids; //[34, 78, 70, 164, 163, 147, 51, 12, 115]
        // liSelectIds = [34, 78, 70, 164, 163, 147, 51, 12, 115, 148, 127, 144, 10]

        var box = liBox[3]

        console.log('data', data, 'bound', bound, steps)
        
        var svg = d3.select('#mysvg')
        var lScaleX = d3.scaleLinear().domain(bound[0]).range([10, 590])
        var lScaleY = d3.scaleLinear().domain(bound[1]).range([10, 590])

        svg.on('click', function(e){
            console.log('mouse', d3.mouse(this), d3.event.clientX, d3.event.clientY)
        })

        var color = d3.schemeOranges[9]
        
        nnodes = {}
        svg.selectAll('circle')
           .data(data)
            .enter()
            .append('circle')
            .attr('id', function(d){
                return 'c_' + d[0] +'_'+d[3]
            })
            .attr('class', function(d){
                return d[0]
            })
            .style('r', 5)
            .style('cx', function(d){
                // console.log(' lScale(Number(d[0])) ', Number(d[1]), lScaleX(Number(d[1])))
                nnodes['c_' + d[0]+'_'+d[3]] = {
                    'x': lScaleX(Number(d[1])),
                    'y': lScaleY(Number(d[2]))
                }
                return lScaleX(Number(d[1]))
            })
            .style('cy', function(d){
            return lScaleY(Number(d[2]))
            })
            .style('fill', function(d){
                return Rcolor(d[3]/steps[steps.length - 1])
                // return color[Math.floor(d[3])]
            })
            .style('stroke', function(d){
                // if(Number(d[3]) >= steps[steps.length - 1] && lScaleX(Number(d[1])) > box[0][0] && lScaleX(Number(d[1])) < box[0][1] 
                //         &&  lScaleY(Number(d[2])) > box[1][0] && lScaleY(Number(d[2])) < box[1][1]){
                //             return 'white'
                //         }
                return Rcolor(0.5)
            })
            .style('visibility', function(d){
                if(liSelectIds.indexOf(d[0]) == -1)
                     return 'visible'
                if(Number(d[3]) < steps[steps.length - 1] )
                    return 'hidden'
                return 'visible'
            })
            .style('opacity', function(d){
                if(Number(d[3]) >= steps[steps.length - 1] && lScaleX(Number(d[1])) > box[0][0] && lScaleX(Number(d[1])) < box[0][1] 
                        &&  lScaleY(Number(d[2])) > box[1][0] && lScaleY(Number(d[2])) < box[1][1])
                            return 1.
                return 0.3
            })
            .on('click', function(d){
                console.log('id=', d[0])
            })

        var lineFunction = d3.line()
                            .x(function(d){return d.x;})
                            .y(function(d){return d.y;})
                            .curve(d3.curveMonotoneX) ;
        
        // var liSelectIds = ids;
        for(var i = 0; i < liSelectIds.length; i ++){
            var lineData = []
            // for(var j = steps.length - 2; j < steps.length; j ++){                
            //     var c = d3.select('#c_' + ids[i] + '_' + steps[j])
            //     lineData.push({
            //         'x': +c.style('cx'),
            //         'y': +c.style('cy')
            //     })
            // }
            
            for(var j = 0; j < steps.length; j ++){                
                var c = d3.select('#c_' + liSelectIds[i] + '_' + steps[j])
                lineData.push({
                    'x': +c.style('cx'),
                    'y': +c.style('cy')
                })

            }
                       
            var lineGraph = svg.append("path")
                        .datum(lineData)
                        .attr('id', 'l_' + liSelectIds[i])
                        .attr("d",lineFunction)
                        .style('stroke', 'black')
                        .style('stroke-width', '4px')
                        .style('fill', 'none');
            
            // continue
            lineGraph.remove()
            // if(lineGraph.node().getTotalLength() < 500)
            //     continue
            // console.log('linegraph=', lineGraph.node())

            svg.selectAll(".s_" + liSelectIds[i])
                .data(quads(samples(lineGraph.node(), 4)))
                .enter()
                .append("path")
                .attr('class', "s_" + liSelectIds[i])
                .style("fill", function(d) { return Rcolor(d.t); })
                .style("stroke", function(d) { return Rcolor(d.t); })
                .attr("d", function(d) { return lineJoin(d[0], d[1], d[2], d[3], 6 * d.t); });

                // .style('visibility', function(d){
                //     if(d[d.length - 1]['x'] > box[0][0] && d[d.length - 1]['x'] < box[0][1] 
                //     && 
                //         d[d.length - 1]['y'] > box[1][0] && d[d.length - 1]['y'] < box[1][1]
                //     )
                //         return 'visible'
                //     return 'hidden'
                // })


                //         .style("stroke","rgb(241, 105, 19)")
                //         .style('stroke', 'url(#orange_red)')
                //         .style("stroke-width", 3)
                //         .style('fill', 'none')
                      
        }
    
        //edge bundling
    //     for(var j = 0; j < steps.length - 1; j ++){
    //         var eedges = []
    //         // var lineData = []
    //         for(var i = 0; i < ids.length; i ++){
    //             var c = ('c_' + ids[i] + '_' + steps[j])
    //             var c_1 = ('c_' + ids[i] + '_' + String(Number(steps[j]) + 1))
    //             eedges.push({
    //                 'source': c, 
    //                 'target': c_1
    //             })
    //             // lineData.push({
    //             //     'x': +c.style('cx'),
    //             //     'y': +c.style('cy')
    //             // })
    //         }
    //         console.log('nnodes', nnodes, 'eedges', eedges)
    //         var fbundling = d3.ForceEdgeBundling().nodes(nnodes).edges(eedges);
    //         var results = fbundling();

    //         console.log('line data', results)
    //         for(var i = 0; i < results.length; i ++){
    //             var lineData = results[i]
    //             var lineGraph = svg.append("path")
    //                         .datum(lineData)
    //                         .attr('id', 'l_' + ids[i])
    //                         .attr("d",lineFunction)
    //                         .style("stroke","#0000ff2b")
    //                         // .style('stroke', 'url(#orange_red)')
    //                         .style("stroke-width",0.5)
    //                         .style('fill', 'none')
    //         }
    //     }
    }
</script>